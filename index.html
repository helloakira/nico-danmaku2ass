<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>nico-xml转ass</title>
		<style type="text/css">
			.divBord {
				border: #000000 4px solid;
				padding: 10px;
			}
		</style>
	</head>
	<body>
		<div>
			主线一：<br />
			搬运LV生放送源：推荐<a href="https://www.bilibili.com/read/cv937578" target="_blank">MINYAMI</a><br />
			补充说明：十分推荐安装配套的CHROME插件，还有加入系统变量。<br />
		</div>
		<br />
		<hr />
		<hr />
		
		
		<div>
			主线二：<br />
			弹幕转ASS：该工具<br /><br />
			<div>标题：<span id="nicoTitle">无</span> </div>
			<div>运营弹幕ID：<span id="officeId">无</span> </div>
			<div>AA时间轴：<span id="AA">无</span> </div>

			<span style="color: red;">细节设置：</span><input type="button" id="optionButtonSlideToggle" value="显示与隐藏"><br />
			<div id="optionDiv" class="divBord" style="display: none;">
				<input type="button" id="saveUseSetting" value="保存用户设置" onclick="saveUseSetting()">&nbsp;&nbsp;<input type="button" id="defaultUseSetting" value="恢复默认设置" onclick="defaultUseSetting()"><br />
				限制普通弹幕行数<input type="text" id="limitLineAmount" name="limitLineAmount" style="width: 30px;" value="11" />行（默认11行满屏 做<span style="color: red;">熟肉</span>写9~10行可空行腾空间）<br />
				普通弹幕前缀添加的<span style="color: red;">ASS代码</span><input type="text" id="assCode" name="assCode" style="width: 300px;" value="\fnMS PGothic\b1\bord2\blur0" />（默认字体MS PGothic 加粗字体 边框2 模糊0）<br />
				普通弹幕大小<input type="text" id="danmakuSize" name="danmakuSize" style="width: 30px;" value="46" />（默认46）<br />
				普通弹幕密度调整<input type="text" id="danmakuDensity" name="danmakuDensity" style="width: 30px;" value="10" />（默认0，越大越密）<br />
				普通弹幕时间轴偏移调整<input type="text" id="startTimeAdjust" name="startTimeAdjust" style="width: 30px;" value="0" />秒（-1提前1秒 1推后1秒）<br />
				普通弹幕滚动速度调整<input type="text" id="danmakuSpeedAdjust" name="danmakuSpeedAdjust" style="width: 30px;" value="1" />秒（-1加快1秒 1减慢1秒）<br />
				是否启用普通弹幕颜色<input type="checkbox" id="useAssColors" name="useAssColors" value="0" checked />（默认使用 不使用全部黑框白字处理）<br />
				是否区分普通弹幕会员与非会员<input type="checkbox" id="difficultVIP" name="difficultVIP" value="0" />（默认不使用 没必要）<br />
				是否过滤非会员<input type="checkbox" id="filterOutsider" name="filterOutsider" value="0" />（默认不使用 没必要）<br />
				是否使用速度算法<input type="checkbox" id="useSpeedA" name="useSpeedA" value="0" />（默认不使用 使用算法滚动速度会平均点）<br />
				手动添加运营弹幕ID<input type="text" id="manualAddOfficeId" name="manualAddOfficeId" style="width: 300px;" value="" />（默认空 用于无法识别或添加特定ID 输入多个用英文的逗号,隔开 如 illumination,gezi,jiaozi,megumi）（只能靠重新刷新页面取消之前手动输过的ID）<br />
				屏蔽过滤关键词<input type="text" id="filterKeywords" name="filterKeywords" style="width: 300px;" value="" />（默认空 输入多个用英文的逗号,隔开 如上）<br />
				
				<br />
				使用方式一的数组数据过大，用自建的TXT转XML，再用方式二转ASS：<input type="file" onchange="uploadBigTXT(this)" id="txtFile" /><input type="button" value="加载" onclick="bigTXT2xml()"><input type="button" value="将其保存为XML" onclick="json2xmlSave()"><br />
			</div>
			
			<br />
			
			<div>
				<div class="divBord">
					方式一：通过浏览器开发工具扣弹幕（推荐用CHROME）<br />
					补充说明：无需转发定向代理无需登录NICO账号，只需在对应已完结生放送的LV页面输入对应命令就能扣。能应对大多LV生放送与SO视频。<br />
					教程：<a href="浏览器扣弹幕使用说明/扣LV弹幕教程.html" target="_blank">扣LV弹幕教程</a>&nbsp;&nbsp;<a href="浏览器扣弹幕使用说明/扣SO弹幕教程.html" target="_blank">扣SO弹幕教程</a><br />
					<br />
						<div>
							1.复制命令：<input id="copyDanmakuComment" type="button" value="将扣弹幕命令复制到剪贴板" onclick="copyDanmakuComment()" data-clipboard-target="#commentTextDiv" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input id="copyDanmakuCommentOnRoom" type="button" value="（爱马仕官方LV生放送ROOM类型专用命令）将扣弹幕命令复制到剪贴板" onclick="copyDanmakuCommentOnRoom()" data-clipboard-target="#commentTextOnRoomDiv" /> <br />
							
							2.加载复制回来的数组：<br /> 
							<textarea id="jsonTextarea" rows="8" cols="40"></textarea><br />
							<input type="button" value="加载" onclick="object2xml()" />
							<input type="button" value="清空" onclick="document.getElementById('jsonTextarea').value=''" /><br />
							3.保存ASS：<input type="button" onclick="newAllSave()" value="将其保存为ASS">
							<input type="button" value="将其保存为XML" onclick="json2xmlSave()">
						</div>
				</div>
				<br />
				<div class="divBord">
					方式二：通过NCV等工具下载回来的XML扣弹幕<br />

					<br />
					1.通过XML加载弹幕：<input type="file" onchange="upload(this)" id="xmlFile" /><br />
					2.保存ASS：<input type="button" onclick="newAllSave()" value="将其保存为ASS"><br />
				</div>
			</div>

		</div>
		<br />
		<hr />
		<hr />
		
		<div>
			主线三：<br />
			生放送源与ASS压制：推荐<a href="https://github.com/hoshinohikari/StarTools/releases" target="_blank">StarTools</a><br \>
			补充说明：显卡压制，能直接拖拽，即便ASS文件含有EMOJI文字用显卡压制时也不会乱码。
		</div>
		
		<!-- 读取到的XML文本预览： -->
		<textarea id="commentTextDiv" style="opacity:0;height: 0px;"></textarea>
		<textarea id="commentTextOnRoomDiv" style="opacity:0;height: 0px;"></textarea>
		
		<!-- 几乎不用的 -->
		<!-- <div class="center-block">
			<div>
				2.一键生成ASS：<br />
				普通弹幕&特殊弹幕合体的ASS：<input type="button" onclick="newAllSave()" value="保存合体弹幕ASS"><br /><br />

				其他输出方式：<input type="button" id="otherOutputButtonSlideToggle" value="显示与隐藏"><br /><br />

				<div id="otherOutputDiv" style="display: none;">
					<hr />
					2.配合niconvert工具用：https://github.com/muzuiget/niconvert <br />
					普通弹幕JSON：<input type="button" onclick="newJsonSave()" value="保存日文弹幕JSON"><br />
					特殊弹幕ASS：<input type="button" onclick="newAssSave()" value="保存特殊弹幕ASS"><br />
					<br /><hr />
					2.配合RabbitC的方法用：https://www.bilibili.com/read/cv1272922 <br />
					去除特殊弹幕的XML：<input type="button" onclick="newXmlSave()" value="保存去除了特殊弹幕XML"><br />
					特殊弹幕ASS：<input type="button" onclick="newAssSave()" value="保存特殊弹幕ASS"><br /><br />
				</div>

			</div>
		</div> -->
		
		<script src="./util/xml2json.js"></script>
		<script src="./util/FileSaver.js"></script>
		<script src="./util/jquery-2.1.1.min.js"></script>
		<script src="./util/clipboard.min.js"></script>
		<script src="./util/danmaku-comment-text.js"></script>
		<script src="./util/idolmaster-namahaishin-comment-text.js"></script>
		
		<!-- JQ -->
		<script>
			$(document).ready(function(){
					$("#otherOutputButtonSlideToggle").click(function(){
						$("#otherOutputDiv").slideToggle();
					});
					$("#optionButtonSlideToggle").click(function(){
						$("#optionDiv").slideToggle();
					});
			});
		</script>
		
		<script>
			document.getElementById("commentTextDiv").innerHTML = window.commentText;
			document.getElementById("commentTextOnRoomDiv").innerHTML = window.commentTextOnRoom;
			
			if (window.localStorage.getItem('useSetting') != null) {
				getUseSetting();
			}
			
			let jsonInnerText = "";
			function upload(input) {
				//支持chrome IE10
				if (window.FileReader) {
					var file = input.files[0];  
					var filename = file.name.split(".")[0];
					document.getElementById("nicoTitle").innerHTML = filename;
					var reader = new FileReader();  
					reader.readAsText(file);
					reader.onload = function() {  
						console.log(this.result);
						jsonInnerText = this.result;
						checkOffice();
					}
				} else {   
					alert('error');   
				}   
			}
			
			let bigTXT = ``;
			function uploadBigTXT(input) {
				//支持chrome IE10
				if (window.FileReader) {
					var file = input.files[0];  
					var filename = file.name.split(".")[0];
					document.getElementById("nicoTitle").innerHTML = filename;
					var reader = new FileReader();  
					reader.readAsText(file);
					reader.onload = function() {
						bigTXT = this.result;
						
					}
				} else {
					alert('error');   
				}   
			}
			
			function bigTXT2xml() {
				console.log(bigTXT);
				
				object2xmlText = "";
				nicoLv = "";
				nicoTitle = "";
				
				// 获取文本框内容
				var apiJsonText = bigTXT;
				apiArray = eval(bigTXT);
				
				if (apiJsonText.indexOf("ping") == -1 && apiJsonText.indexOf("content")) {
					// 获取标题
					nicoLv = apiArray[0].thread.lv;
					nicoTitle = apiArray[0].thread.title;
			
					document.getElementById("nicoTitle").innerHTML = `${nicoLv} - ${nicoTitle}`;
					
					// 处理thread
					let threadJuzi = "<thread";
					for (let key in apiArray[0].thread) {
						threadJuzi += ` ${key}="${apiArray[0].thread[key]}"`;
					}
					threadJuzi += ` />`
					
					apiArray.shift();
					
					// 处理chat
					let chatJuzis = "";
					apiArray.map((item,index) => {
						let chatJuzi = `<chat`
						for (let key in item.chat) {
							if (key != "content") {
								chatJuzi += ` ${key}="${item.chat[key]}"`;
							}
						}
					
						content_RegExp = jsonToXml_RegExp(item.chat.content);
						chatJuzi += `>${content_RegExp}</chat>\n`;
					
						chatJuzis += chatJuzi;
					})
					object2xmlText = `<?xml version='1.0' encoding='UTF-8'?>\n<packet>\n${threadJuzi}\n${chatJuzis}</packet>`;

					console.log(object2xmlText);
				} else {
					// 处理chat
					let chatJuzis = "";
					apiArray.map((item,index) => {
						if (item.hasOwnProperty("chat") == true) {
							let chatJuzi = `<chat`
							for (let key in item.chat) {
								if (key != "content") {
									chatJuzi += ` ${key}="${item.chat[key]}"`;
								}
							}
							content_RegExp = jsonToXml_RegExp(item.chat.content);
							chatJuzi += `>${content_RegExp}</chat>\n`;
												
							chatJuzis += chatJuzi;
						} 
					})
					object2xmlText = `<?xml version='1.0' encoding='UTF-8'?>\n<packet>\n${chatJuzis}</packet>`;
				}
			}

			let object2xmlText = "";
			var nicoLv = "";
			var nicoTitle = "";
			
			function object2xml() {
				object2xmlText = "";
				nicoLv = "";
				nicoTitle = "";
				
				// 获取文本框内容
				var apiJsonText = document.getElementById('jsonTextarea').value;
				apiArray = eval(apiJsonText);
				
				if (apiJsonText.indexOf("ping") == -1 && apiJsonText.indexOf("content")) {
					// 获取标题
					nicoLv = apiArray[0].thread.lv;
					nicoTitle = apiArray[0].thread.title;

					document.getElementById("nicoTitle").innerHTML = `${nicoLv} - ${nicoTitle}`;
					
					// 处理thread
					let threadJuzi = "<thread";
					for (let key in apiArray[0].thread) {
						threadJuzi += ` ${key}="${apiArray[0].thread[key]}"`;
					}
					threadJuzi += ` />`
					
					apiArray.shift();
					
					// 处理chat
					let chatJuzis = "";
					apiArray.map((item,index) => {
						let chatJuzi = `<chat`
						for (let key in item.chat) {
							if (key != "content") {
								chatJuzi += ` ${key}="${item.chat[key]}"`;
							}
						}
					
						content_RegExp = jsonToXml_RegExp(item.chat.content);
						chatJuzi += `>${content_RegExp}</chat>\n`;
					
						chatJuzis += chatJuzi;
					})
					object2xmlText = `<?xml version='1.0' encoding='UTF-8'?>\n<packet>\n${threadJuzi}\n${chatJuzis}</packet>`;
					
					jsonInnerText = object2xmlText;
					console.log(object2xmlText);
					checkOffice();
				} else {
					// 处理chat
					let chatJuzis = "";
					apiArray.map((item,index) => {
						if (item.hasOwnProperty("chat") == true) {
							let chatJuzi = `<chat`
							for (let key in item.chat) {
								if (key != "content") {
									chatJuzi += ` ${key}="${item.chat[key]}"`;
								}
							}
							content_RegExp = jsonToXml_RegExp(item.chat.content);
							chatJuzi += `>${content_RegExp}</chat>\n`;
												
							chatJuzis += chatJuzi;
						} 
					})
					object2xmlText = `<?xml version='1.0' encoding='UTF-8'?>\n<packet>\n${chatJuzis}</packet>`;
					
					jsonInnerText = object2xmlText;
				}
			}
			
			function checkOffice() {
				// 初始化XML转JS
				var x2js = new X2JS({
					stripWhitespaces: false
				});
				
				// 获取ID显示节点
				var Dom_officeId = document.getElementById("officeId");
				
				// 拿文本
				var text = jsonInnerText;
				// 转文本转成json
				var jsonObjectAll = x2js.xml_str2json( jsonInnerText );
				// 判断是否为NicomentXenoglossia处理过的
				var jsonObject = (!jsonObjectAll.hasOwnProperty("NiconamaComment") ?jsonObjectAll["packet"]["chat"]:jsonObjectAll["NiconamaComment"]["LiveCommentDataArray"]["chat"]);
				// 排序
				jsonObject.sort(sort_vpos);
				
				// 初始化
				var officeIds = [];
				
				// 添加的官方弹幕ID
				var addOfficeIdArray = [];
				var addOfficeId = '0';

				jsonObject.map((item, index)=>{
					var text = item["__text"];
					var id = item["_user_id"];

					var premium = item["_premium"];

					if (premium == "3") {
						if ( text.indexOf("/trialpanel") == -1 && text.indexOf("/nicoad") == -1 && text.indexOf("/spi") == -1 && text.indexOf("/gift") == -1 && text.indexOf("/info") == -1 && text.indexOf("/commentlock") == -1 ) {
							if ( (addOfficeIdArray.indexOf(id) == -1) ) {
								addOfficeIdArray.push(id);
							}
						}
					}
				});
				
				if( addOfficeIdArray.length > 0 ) {
					Dom_officeId.textContent = addOfficeIdArray.join(",");
				} else {
					Dom_officeId.textContent = "无法自动查找到运营ID 请从页面细节设置中手动添加";
				}
				
				return addOfficeIdArray;
				
			}
			
			
			// 全局数组接受遍历得到的数据生成JSON
			var newArray = [];
			// 全局字符串得到数据生成ASS
			var juzis = '';
			// 全局chat元素数据生成XML
			var allChat = [];
			var jsonObjectAll_XML = {};

			// 合体弹幕
			var allDanmaku = '';
			
			// AA弹幕时间显示数组
			var allAAStartTimeArray = [];
			
			function main() {
				// 初始化blob
				newArray = [];
				juzis = '';
				allChat = [];
				allDanmaku = '';
				allAAStartTimeArray = [];
				
				// 新建运营弹幕ID
				var officeIds = [];
				
				// AA字体大小
				var AASize = 20;
				var AAHighAdjust = 80;
				
				// 运营弹幕字体大小等
				var OfficeSize = 20;
				var OfficeBgHeight = 32;
				
				// 普通弹幕调整
				var danmakuLineHeight = 64;
				var danmakuFontSpace = 2;
				
				// 颜色值
				var css2ass = { aliceblue: "#F0F8FF", antiquewhite: "#FAEBD7", aqua: "#00FFFF", aquamarine: "#7FFFD4", azure: "#F0FFFF", beige: "#F5F5DC", bisque: "#FFE4C4", black: "#000000", blanchedalmond: "#FFEBCD", blue: "#0000FF", blueviolet: "#8A2BE2", brown: "#A52A2A", burlywood: "#DEB887", cadetblue: "#5F9EA0", chartreuse: "#7FFF00", chocolate: "#D2691E", coral: "#FF7F50", cornflowerblue: "#6495ED", cornsilk: "#FFF8DC", crimson: "#DC143C", cyan: "#00FFFF", darkblue: "#00008B", darkcyan: "#008B8B", darkgoldenrod: "#B8860B", darkgray: "#A9A9A9", darkgreen: "#006400", darkkhaki: "#BDB76B", darkmagenta: "#8B008B", darkolivegreen: "#556B2F", darkorange: "#FF8C00", darkorchid: "#9932CC", darkred: "#8B0000", darksalmon: "#E9967A", darkseagreen: "#8FBC8F", darkslateblue: "#483D8B", darkslategray: "#2F4F4F", darkturquoise: "#00CED1", darkviolet: "#9400D3", deeppink: "#FF1493", deepskyblue: "#00BFFF", dimgray: "#696969", dodgerblue: "#1E90FF", feldspar: "#D19275", firebrick: "#B22222", floralwhite: "#FFFAF0", forestgreen: "#228B22", fuchsia: "#FF00FF", gainsboro: "#DCDCDC", ghostwhite: "#F8F8FF", gold: "#FFD700", goldenrod: "#DAA520", gray: "#808080", green: "#008000", greenyellow: "#ADFF2F", honeydew: "#F0FFF0", hotpink: "#FF69B4", indianred: "#CD5C5C", indigo: "#4B0082", ivory: "#FFFFF0", khaki: "#F0E68C", lavender: "#E6E6FA", lavenderblush: "#FFF0F5", lawngreen: "#7CFC00", lemonchiffon: "#FFFACD", lightblue: "#ADD8E6", lightcoral: "#F08080", lightcyan: "#E0FFFF", lightgoldenrodyellow: "#FAFAD2", lightgrey: "#D3D3D3", lightgreen: "#90EE90", lightpink: "#FFB6C1", lightsalmon: "#FFA07A", lightseagreen: "#20B2AA", lightskyblue: "#87CEFA", lightslateblue: "#8470FF", lightslategray: "#778899", lightsteelblue: "#B0C4DE", lightyellow: "#FFFFE0", lime: "#00FF00", limegreen: "#32CD32", linen: "#FAF0E6", magenta: "#FF00FF", maroon: "#800000", mediumaquamarine: "#66CDAA", mediumblue: "#0000CD", mediumorchid: "#BA55D3", mediumpurple: "#9370D8", mediumseagreen: "#3CB371", mediumslateblue: "#7B68EE", mediumspringgreen: "#00FA9A", mediumturquoise: "#48D1CC", mediumvioletred: "#C71585", midnightblue: "#191970", mintcream: "#F5FFFA", mistyrose: "#FFE4E1", moccasin: "#FFE4B5", navajowhite: "#FFDEAD", navy: "#000080", oldlace: "#FDF5E6", olive: "#808000", olivedrab: "#6B8E23", orange: "#FFA500", orangered: "#FF4500", orchid: "#DA70D6", palegoldenrod: "#EEE8AA", palegreen: "#98FB98", paleturquoise: "#AFEEEE", palevioletred: "#D87093", papayawhip: "#FFEFD5", peachpuff: "#FFDAB9", peru: "#CD853F", pink: "#FFC0CB", plum: "#DDA0DD", powderblue: "#B0E0E6", purple: "#800080", red: "#FF0000", rosybrown: "#BC8F8F", royalblue: "#4169E1", saddlebrown: "#8B4513", salmon: "#FA8072", sandybrown: "#F4A460", seagreen: "#2E8B57", seashell: "#FFF5EE", sienna: "#A0522D", silver: "#C0C0C0", skyblue: "#87CEEB", slateblue: "#6A5ACD", slategray: "#708090", snow: "#FFFAFA", springgreen: "#00FF7F", steelblue: "#4682B4", tan: "#D2B48C", teal: "#008080", thistle: "#D8BFD8", tomato: "#FF6347", turquoise: "#40E0D0", violet: "#EE82EE", violetred: "#D02090", wheat: "#F5DEB3", white: "#FFFFFF", whitesmoke: "#F5F5F5", yellow: "#FFFF00", yellowgreen: "#9ACD32" };
				
				// 初始化XML转JS
				var x2js = new X2JS({
					stripWhitespaces: false
				});
				
				// 拿文本
				var text = jsonInnerText;

				// 转文本转成json
				var jsonObjectAll = x2js.xml_str2json( jsonInnerText );

				// 判断是否为NicomentXenoglossia处理过的
				var jsonObject = (!jsonObjectAll.hasOwnProperty("NiconamaComment") ?jsonObjectAll["packet"]["chat"]:jsonObjectAll["NiconamaComment"]["LiveCommentDataArray"]["chat"]);
				
				// 拷贝一份jsonObject 用于生成新XML
				jsonObjectAll_XML = JSON.parse(JSON.stringify(jsonObjectAll));

				// 页面输入的值调整
				var limitLineAmount = document.getElementById("limitLineAmount").value;
				var startTimeAdjust = parseFloat(document.getElementById("startTimeAdjust").value);
				var danmakuSpeedAdjust = parseFloat(document.getElementById("danmakuSpeedAdjust").value);
				var danmakuSize = parseFloat(document.getElementById("danmakuSize").value);
				var danmakuDensity = parseFloat(document.getElementById("danmakuDensity").value);
				
				// ASS头文件
				var header = `[Script Info]\n\
				; Script generated by Aegisub 3.2.2\n\
				; http://www.aegisub.org/\n\
				ScriptType: v4.00+\n\
				PlayResX: 1280\n\
				PlayResY: 720\n\
				\n\
				[Aegisub Project Garbage]\n\
				Active Line: 11\n\
				\n\
				[V4+ Styles]\n\
				Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding\n\
				Style: Default,微软雅黑,54,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,2,0,2,30,30,120,0\n\
				Style: Alternate,微软雅黑,36,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,2,0,2,30,30,84,0\n\
				Style: AA,Yu Gothic,${AASize},&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,0,2,2,30,30,84,0\n\
				Style: Office,MS PGothic,${OfficeSize},&H00FFFFFF,&H00FFFFFF,&H14000000,&H00000000,-1,0,0,0,100,100,2,0,1,2,0,2,30,30,30,0\n\
				Style: Anketo,MS PGothic,${danmakuSize},&H00FFFFFF,&H00FFFFFF,&H14000000,&H00000000,-1,0,0,0,100,100,2,0,1,2,0,2,30,30,30,0\n\
				Style: Shita,MS PGothic,${danmakuSize},&H00FFFFFF,&H00FFFFFF,&H14000000,&H00000000,-1,0,0,0,100,100,2,0,1,2,0,2,30,30,0,0\n\
				Style: Danmaku,MS PGothic,${danmakuSize},&H00FFFFFF,&H00FFFFFF,&H14000000,&H00000000,-1,0,0,0,100,100,2,0,1,2,0,2,30,30,30,0\n\n\
				[Events]\n\
				Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text`;;
				
				// ASS代码前缀
				var assCode = document.getElementById("assCode").value;
				
				// 各种打勾取值
				$useAssColors = document.getElementById("useAssColors");
				$difficultVIP = document.getElementById("difficultVIP");
				$useSpeedA = document.getElementById("useSpeedA");
				$filterOutsider = document.getElementById("filterOutsider");

				// 查找到添加官方弹幕ID数组
				var addOfficeIdArrays = checkOffice();
				
				addOfficeIdArrays.map( (item,index) => {
					if( !officeIds.includes(item) && addOfficeIdArrays.length > 0 ) {
						officeIds.push(item);
					}
				})
				
				// 获取页面手动添加的官方弹幕ID
				var $manualAddOfficeId = document.getElementById('manualAddOfficeId').value;
				var manualAddOfficeIdArrays = $manualAddOfficeId.trim().split(',');
				
				manualAddOfficeIdArrays.map( (item,index) => {
					if( !officeIds.includes(item) && manualAddOfficeIdArrays.length > 0 && item != '' ) {
						officeIds.push(item);
					}
				})
				
				// 获取页面手动添加的关键词
				var $filterKeywords = document.getElementById('filterKeywords').value;
				var filterKeywordsArrays = $filterKeywords.trim().split(',');
				
				// 头文件合并句子
				juzis = header +"\n";

				// 初始化各种句子
				var juziAA = "";
				var juziOffice = "";
				var juziDamaku = "";
				var juziShita = "";
				
				// 初始化视频数据自适应
				var videoWidth = 1280;	// 视频宽
				var videoHeight = 720;	// 视频高
				// 定位用像素
				var px64 = 64;			// 字体大小
				
				// 初始化弹幕问卷框大小
				var bgWidth = Math.floor(videoWidth/4);
				var bgHeight = Math.floor(videoHeight/3);
				var resultBgLength = Math.floor(videoWidth/6);
				var resultBgHeight = Math.floor(px64);
				
				// 初始化弹幕问卷框位置
				// X轴
				var XArray = [[Math.floor(bgWidth/2)],[Math.floor(videoWidth/3)-40,(Math.floor(videoWidth/2)-Math.floor(videoWidth/3))+Math.floor(videoWidth/2)+40],[Math.floor(videoWidth/2)-bgWidth-40,Math.floor(videoWidth/2),Math.floor(videoWidth/2)+bgWidth+40]];
				// Y轴
				var YArray = [[Math.floor(videoHeight/2)],[Math.floor(videoHeight/3),(Math.floor(videoHeight/2)-Math.floor(videoHeight/3))+Math.floor(videoHeight/2)],[Math.floor(videoHeight/2)-bgHeight-20,Math.floor(videoHeight/2),Math.floor(videoHeight/2)+bgHeight+20]];

				// 处理运营弹幕
				var startTimeQ;	// 问卷开始时间
				var textQ;			// 问卷题目文本
				var textArrayQ;	// 问卷题目数组文本
				var textArrayR;	// 问卷结果文本
				// 运营弹幕遮罩
				var officeBg = `m 0 0 l ${videoWidth+20} 0 l ${videoWidth+20} ${OfficeBgHeight} l 0 ${OfficeBgHeight}`;
				
				// 弹幕池默认11行
				var danmakuPassageway = [];
				var danmakuPassageway_textWidth = [];
				var danmakuPassageway_averageSpeed = [];
				var danmakuPassageway_spaceTime = [];
				var danmakuPassageway_finishTime = [];
				
				for (var i = 0; i < limitLineAmount; i++) {
					danmakuPassageway.push(0);
					danmakuPassageway_textWidth.push(0);
					danmakuPassageway_averageSpeed.push(0);
					danmakuPassageway_spaceTime.push(0);
					danmakuPassageway_finishTime.push(0);
				}
				// 排序
				jsonObject.sort(sort_vpos);
				
				jsonObject.map((item, index) => {
					// 处理NG
					var frist = item["__text"].substring(0,1);
					if(item["__text"] == "※ NGコメントです ※") {
						return true;
					}

					// 处理没有VSOP的
					if (item.hasOwnProperty("_vpos") == false) {
						return true;
					}
					
					// 处理没有VSOP为负
					if (item["_vpos"].indexOf("-") >-1) {
						return true;
					}
					
					// 初始化运营弹幕框
					OfficeBgHeight = 32;
					
					// 处理开始时间
					var startSeconds = (item["_vpos"]/100).toFixed(2);
					var startSecondsArray = startSeconds.toString().split(".");
					var startTime = timeFormat(parseInt(startSecondsArray[0]))+"."+startSecondsArray[1];
					// 处理默认结束时间10秒
					var endSeconds = (item["_vpos"]/100+10).toFixed(2);
					var endSecondsArray = endSeconds.toString().split(".");
					var endTime = timeFormat(parseInt(endSecondsArray[0]))+"."+endSecondsArray[1];

					// 找运营ID 只有运营ID才发投票
					if(officeIds.includes(item["_user_id"])) {
						// 分割运营文本 如下
						// 投票开始 /vote start 和気あいあいとプレイしていた？ Yes! No...
						// 投票结束 /vote showresult per 438 562
						var textArray = item["__text"].split(" ");
						
						// console.log(textArray);
						
						// 找投票开始
						if (textArray[0] == "/vote" && textArray[1] == "start") {
							// 处理问卷调查开始时间
							var startSeconds = (item["_vpos"]/100).toFixed(2);
							var startSecondsArray = startSeconds.toString().split(".");
							startTimeQ = timeFormat(parseInt(startSecondsArray[0]))+"."+startSecondsArray[1];
							
							// 问题文本赋值
							textQ = textArray[2];
							// 从第三个开始赋值数组 ["Yes!","No..."]
							textArrayQ = textArray.slice(3);
							
							// 含双引号修复
							let hasDoubleQuotation = [];
							for (let i = 0; i < textArrayQ.length; i++) {
								if (textArrayQ[i].indexOf('"') != -1 && (textArrayQ[i].indexOf('"') == textArrayQ[i].lastIndexOf('"')) ) {
									hasDoubleQuotation.push(i);
								}
							}

							if (hasDoubleQuotation.length >=2) {
								for (let i = 0; i < hasDoubleQuotation.length; i+=2) {
									
									textArrayQ.splice(hasDoubleQuotation[i],hasDoubleQuotation[i+1]+1,textArrayQ.slice(hasDoubleQuotation[i],hasDoubleQuotation[i+1]+1).join(" ").replace(/"/g,'').replace(/,/g,''));
									console.log(textArrayQ);
								}
							}
						}
						
						// 找投票结束
						if (textArray[0] == "/vote" && textArray[1] == "showresult") {
							// 从第三个开始赋值数组 [438,562]
							textArrayR = textArray.slice(3);
							
							// 处理问卷调查出结果时间
							var startSeconds = (item["_vpos"]/100).toFixed(2);
							var startSecondsArray = startSeconds.toString().split(".");
							var startTimeR = timeFormat(parseInt(startSecondsArray[0]))+"."+startSecondsArray[1];
							
							// 处理结束时间为开始时间16秒后
							var endSeconds = (item["_vpos"]/100+16).toFixed(2);
							var endSecondsArray = endSeconds.toString().split(".");
							var endTime = timeFormat(parseInt(endSecondsArray[0]))+"."+endSecondsArray[1];
							
							// 最上方问题文本样式
							var QuestjuziBg = `Dialogue: 5,${startTimeQ},${endTime},Office,,0,0,0,,{\\an5\\p1\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&H000000&\\1a&H78&}${officeBg}\n`;
							var QuestjuziText = `Dialogue: 5,${startTimeQ},${endTime},Office,,0,0,0,,{\\an5\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&HFFFFFF&\\fsp0}{\\1c&HFFCF00&}Q:{\\1c}${textQ}\n`;
							var QuestMask = `Dialogue: 3,${startTimeQ},${endTime},Office,,0,0,0,,{\\an5\\p1\\bord0\\1c&H000000&\\pos(${videoWidth/2},${videoHeight/2})\\1a&HC8&}m 0 0 l ${videoWidth+20} 0 l ${videoWidth+20} ${videoHeight+20} l 0 ${videoHeight+20}\n`;
							
							var quest = QuestjuziBg + QuestjuziText + QuestMask;
							
							// 只有两个问卷调查选项
							if(textArrayR.length == 2) {
								// 问题框长宽
								var bgWidth = Math.floor(videoWidth/3);
								var bgHeight = Math.floor(videoHeight/2);
								var resultBgLength = Math.floor(bgWidth/2);
								var resultBgHeight = Math.floor(px64);
								
								// X轴
								XArray = [[Math.floor(bgWidth/2)],[Math.floor(videoWidth/3)-40,(Math.floor(videoWidth/2)-Math.floor(videoWidth/3))+Math.floor(videoWidth/2)+40],[Math.floor(videoWidth/2)-bgWidth-40,Math.floor(videoWidth/2),Math.floor(videoWidth/2)+bgWidth+40]];
								// Y轴
								YArray = [[Math.floor(videoHeight/2)],[Math.floor(videoHeight/3),(Math.floor(videoHeight/2)-Math.floor(videoHeight/3))+Math.floor(videoHeight/2)],[Math.floor(videoHeight/2)-bgHeight-40,Math.floor(videoHeight/2),Math.floor(videoHeight/2)+bgHeight+40]];
								
								// 转化ASS绘图代码
								var numBg = `m 0 0 l ${px64*2} 0 l ${px64*2} 0 l 0 ${px64*2}`;
								var bg = `m 0 0 l ${bgWidth} 0 l ${bgWidth} ${bgHeight} l 0 ${bgHeight}`;
								var resultBg = `m 0 0 l ${resultBgLength} 0 l ${resultBgLength} ${resultBgHeight} l 0 ${resultBgHeight}`;
								
								// 问题位置
								var X = XArray[1];
								var Y = YArray[0];
								
								// 数据合集
								var all = "";
								
								for (var j = 0; j < Y.length; j++) {
									for (var i = 0; i < X.length; i++) {
										var oneNumBg = `Dialogue: 5,${startTimeQ},${endTime},Anketo,,0,0,0,,{\\an5\\p1\\bord0\\1c&H3E2E2A&\\pos(${X[i]-Math.floor(bgWidth/2)+px64},${Y[j]-Math.floor(bgHeight/2)+px64})}${numBg}\n`
										var oneNumText = `Dialogue: 5,${startTimeQ},${endTime},Anketo,,0,0,0,,{\\an5\\bord0\\1c&H76FAF8&\\pos(${X[i]-Math.floor(bgWidth/2)+Math.floor(px64/2)},${Y[j]-Math.floor(bgHeight/2)+Math.floor(px64/2)})}${i+1}\n`;
										
										var oneBg = `Dialogue: 5,${startTimeQ},${endTime},Anketo,,0,0,0,,{\\an5\\p1\\3c&HFFFFFF&\\bord6\\1c&HD5A07B&\\1a&H78&\\pos(${X[i]},${Y[j]})}${bg}\n`
										
										// 处理多余空行
										var text_16 = textArrayQ[i].replace(/[^\x00-\xff]/g,"$&\x01").replace(/.{16}\x01?/g,"$&\\N").replace(/\x01/g,"");
										var oneText = `Dialogue: 5,${startTimeQ},${endTime},Anketo,,0,0,0,,{\\an5\\bord0\\1c&HFFFFFF&\\pos(${X[i]},${Y[j]})}${text_16}\n`;
										
										var oneResultBg = `Dialogue: 5,${startTimeR},${endTime},Anketo,,0,0,0,,{\\an5\\p1\\bord0\\1c&H3E2E2A&\\pos(${X[i]},${Y[j]+Math.floor(bgHeight/2)})}${resultBg}\n`
										var oneResultext = `Dialogue: 5,${startTimeR},${endTime},Anketo,,0,0,0,,{\\an5\\bord0\\1c&H76FAF8&\\pos(${X[i]},${Y[j]+Math.floor(bgHeight/2)})}${ parseInt(textArrayR[i])/10 }%\n`;
										
										all += oneBg + oneText + oneResultBg + oneResultext + oneNumBg + oneNumText;
									}
								}
								
								juziOffice += quest+all;
								
								// 返回true跳过 执行下一句 防止加入普通弹幕
								return true;
							}	// 两个时
							
							// 两个以上
							if (textArrayR.length >= 3) {	
								var px64_anketo = Math.floor(px64/4*3);
								
								var bgWidth = Math.floor(videoWidth/4);
								var bgHeight = Math.floor(videoHeight/5);
								var resultBgLength = Math.floor(bgWidth/2);
								var resultBgHeight = Math.floor(px64_anketo);
								
								// X轴
								XArray = [[Math.floor(bgWidth/2)],[Math.floor(videoWidth/3)-40,(Math.floor(videoWidth/2)-Math.floor(videoWidth/3))+Math.floor(videoWidth/2)+40],[Math.floor(videoWidth/2)-bgWidth-40,Math.floor(videoWidth/2),Math.floor(videoWidth/2)+bgWidth+40]];
								// Y轴
								YArray = [[Math.floor(videoHeight/2)],[Math.floor(videoHeight/3),(Math.floor(videoHeight/2)-Math.floor(videoHeight/3))+Math.floor(videoHeight/2)],[Math.floor(videoHeight/2)-bgHeight-40,Math.floor(videoHeight/2),Math.floor(videoHeight/2)+bgHeight+40]];
								
								// 问题位置
								var X = XArray[2];
								var Y = YArray[2];
								
								if (textArrayR.length < 4) {
									bgHeight = Math.floor(videoHeight/3)
									X = XArray[2];
									Y = YArray[0];
								}
								
								if (textArrayR.length == 4) {
									bgWidth = Math.floor(videoWidth/3);
									bgHeight = Math.floor(videoHeight/4);
									X = XArray[1];
									Y = YArray[1];
								}
								
								if (textArrayR.length >=5 && textArrayR.length <=6 ) {
									bgHeight = Math.floor(videoHeight/4);
									var Y = YArray[1];
								}
								
								if (textArrayR.length > 6 ) {
									var Y = YArray[2];
								}
								
								// 背景
								var numBg = `m 0 0 l ${Math.floor(px64_anketo*1.5)} 0 l ${Math.floor(px64_anketo*1.5)} 0 l 0 ${Math.floor(px64_anketo*1.5)}`;
								var bg = `m 0 0 l ${bgWidth} 0 l ${bgWidth} ${bgHeight} l 0 ${bgHeight}`;
								var resultBg = `m 0 0 l ${resultBgLength} 0 l ${resultBgLength} ${resultBgHeight} l 0 ${resultBgHeight}`;
								
								// 字符串与排序
								var all = "";
								var num = 1;
								
								for (var j = 0; j < Y.length; j++) {
									for (var i = 0; i < X.length; i++) {
										if ( textArrayQ[num-1] == undefined) {
											continue;
										}
										
										var oneNumBg = `Dialogue: 5,${startTimeQ},${endTime},Anketo,,0,0,0,,{\\an5\\p1\\bord0\\1c&H3E2E2A&\\pos(${X[i]-Math.floor(bgWidth/2)+Math.floor(px64_anketo*1.5/2)},${Y[j]-Math.floor(bgHeight/2)+Math.floor(px64_anketo*1.5/2)})}${numBg}\n`
										var oneNumText = `Dialogue: 5,${startTimeQ},${endTime},Anketo,,0,0,0,,{\\fs${parseInt(danmakuSize/4*3)}\\an5\\bord0\\1c&H76FAF8&\\pos(${X[i]-Math.floor(bgWidth/2)+Math.floor(px64_anketo/2)},${Y[j]-Math.floor(bgHeight/2)+Math.floor(px64_anketo/2)})}${num}\n`;
										
										var oneBg = `Dialogue: 5,${startTimeQ},${endTime},Anketo,,0,0,0,,{\\an5\\p1\\3c&HFFFFFF&\\bord4\\1c&HD5A07B&\\1a&H78&\\pos(${X[i]},${Y[j]})}${bg}\n`
										// 多余的空行
										var text_16 = textArrayQ[num-1].replace(/[^\x00-\xff]/g,"$&\x01").replace(/.{16}\x01?/g,"$&\\N").replace(/\x01/g,"");
										var oneText = `Dialogue: 5,${startTimeQ},${endTime},Anketo,,0,0,0,,{\\fs${parseInt(danmakuSize/4*3)}\\an5\\bord0\\1c&HFFFFFF&\\pos(${X[i]},${Y[j]})}${text_16}\n`;
										
										var oneResultBg = `Dialogue: 5,${startTimeR},${endTime},Anketo,,0,0,0,,{\\an5\\p1\\bord0\\1c&H3E2E2A&\\pos(${X[i]},${Y[j]+Math.floor(bgHeight/2)})}${resultBg}\n`
										var oneResultext = `Dialogue: 5,${startTimeR},${endTime},Anketo,,0,0,0,,{\\fs${parseInt(danmakuSize/4*3)}\\an5\\bord0\\1c&H76FAF8&\\pos(${X[i]},${Y[j]+Math.floor(bgHeight/2)})}${ parseInt(textArrayR[num-1])/10 }%\n`;
										
										num++;
										
										all += oneBg + oneText + oneResultBg + oneResultext + oneNumBg + oneNumText;
									}
								}
								
								juziOffice += quest+all;
								return true;
								
							}
							
							
						}	// 问卷调查投票
						
						// 运营弹幕黑框高度初始值
						officeBg = `m 0 0 l ${videoWidth+20} 0 l ${videoWidth+20} ${OfficeBgHeight} l 0 ${OfficeBgHeight}`;

						// 截取开头
						var frist = item["__text"].substring(0,1);

						// 处理开头/的
						if (frist == "/") {
							
							// 排去各种礼物等
							if (item["__text"] == "/clear") {
								return true;
							}
							if (item["__text"].indexOf("vote") != -1) {
								return true;
							};

							if (item["__text"].indexOf("/nicoad") != -1) {
								return true;
							};
							
							if (item["__text"].indexOf("/gift") != -1) {
								return true;
							};
							
							if (item["__text"].indexOf("/spi") != -1) {
								return true;
							};
							
							if (item["__text"].indexOf("/info") != -1) {
								return true;
							};
							
							var spaceIndex = item["__text"].indexOf(" ");
							item["__text"] = item["__text"].substring(spaceIndex+1);
						}
						
						// 处理链接
						// 防止/perm之后<嵌套
						frist = item["__text"].substring(0,1);

						if (frist == "<") {
							var aAnchor = parseToDOM(item["__text"]);;
							var uTextContent = aAnchor[0].childNodes[0].textContent;
							
							var juziBg = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\p1\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&H000000&\\1a&H78&}${officeBg}\n`;
							var juziText = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&HFFCF00&\\u1\\fsp0}${uTextContent}\n`;
							
							var textLength = Math.ceil(strlen(uTextContent)/2);
							
							
							if ( textLength >= 60 ) {
								var text = uTextContent.replace(/[^\x00-\xff]/g,"$&\x01").replace(/.{96}\x01?/g,"$&\\N").replace(/\x01/g,"");

								var n=0;
								var arr=[];

								while(text.indexOf('\\N',n) != -1){
									var m=text.indexOf('\\N',n);
									n=m+1;
									arr.push(m);
								}
								
								OfficeBgHeight = OfficeBgHeight + Math.max(OfficeBgHeight * (arr.length),OfficeBgHeight) ;
								officeBg = `m 0 0 l ${videoWidth+20} 0 l ${videoWidth+20} ${OfficeBgHeight} l 0 ${OfficeBgHeight}`;
								
								juziBg = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\p1\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&H000000&\\1a&H78&}${officeBg}\n`;
								juziText = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\fscx90\\fscy90\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&HFFCF00&\\u1\\fsp0}${text}\n`;
							}
							
							juziOffice += juziBg+juziText;
							
							return true;

						}

						// 普通运营文本
						var text = item["__text"].replace(/\n/g,'\\N');

						var juziBg = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\p1\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&H000000&\\1a&H78&}${officeBg}\n`;
						var juziText = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&HFFFFFF&\\fsp0}${text}\n`;

						if (item["_premium"] == "7" && item.hasOwnProperty("_name")) {
							var premium7Name = item["_name"];
							
							juziText = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&HFFFFFF&\\fsp0}${premium7Name}：${text}\n`;
						}

						var textLength = Math.ceil(strlen(item["__text"])/2);
						
						
						
						if ( textLength >= 60 ) {
							var text = text.replace(/[^\x00-\xff]/g,"$&\x01").replace(/.{96}\x01?/g,"$&\\N").replace(/\x01/g,"");

							var n=0;
							var arr=[];

							while(text.indexOf('\\N',n) != -1){
								var m=text.indexOf('\\N',n);
								n=m+1;
								arr.push(m);
							}
							
							OfficeBgHeight = OfficeBgHeight + Math.max(OfficeBgHeight * (arr.length),OfficeBgHeight);
							officeBg = `m 0 0 l ${videoWidth+20} 0 l ${videoWidth+20} ${OfficeBgHeight} l 0 ${OfficeBgHeight}`;

							juziBg = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\p1\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&H000000&\\1a&H78&}${officeBg}\n`;
							juziText = `Dialogue: 5,${startTime},${endTime},Office,,0,0,0,,{\\an5\\fscx90\\fscy90\\pos(${videoWidth/2},${Math.floor(OfficeBgHeight/2)})\\bord0\\1c&HFFFFFF&}${text}\n`;
						}
						
						juziOffice += juziBg+juziText;
						
						return true;
						
					}	// 运营弹幕
					
					// 处理AA弹幕
					if(item["__text"].length >= 70 && !officeIds.includes(item["_user_id"])) {
						// 处理默认结束时间8秒
						endSeconds = (item["_vpos"]/100+8).toFixed(2);
						endSecondsArray = endSeconds.toString().split(".");
						endTime = timeFormat(parseInt(endSecondsArray[0]))+"."+endSecondsArray[1];
						
						
						// 处理颜色 默认白色
						var color = "ffffff";
						var colorASS = "HFFFFFF";
						if(item.hasOwnProperty("_mail")) {
							// orange4 solid ???
							var findColorArray = item["_mail"].split(" ");
							
							// 去除数字颜色的名字
							var colorName = "";
							
							// 找索引
							var colorIndex = findColorArray.findIndex((item, index) => {
								// 找不是开头#的 去掉数字
								if(findColorArray[index].substring(0, 1) !="#") {
									colorName = findColorArray[index].replace(/\d+/g,'')
								}
								
								var css2ass_find_item = css2ass[colorName];
								// 找black的
								if(css2ass_find_item != undefined && css2ass_find_item.substring(0, 1) =="#") {
									return true;
								}
								
								// 找#开头的
								if(findColorArray[index] != undefined && findColorArray[index].substring(0, 1) =="#") {
									return true;
								}
							});

							var color_item = findColorArray[colorIndex];
							// 处理black的
							var css2ass_item = css2ass[colorName];
							if(colorIndex != -1 && css2ass_item != undefined && css2ass_item.substring(0, 1) =="#") {
								color = css2ass[colorName].substring(1, 7);
								colorASS = "H" + css2ass_item.substring(5, 7)+css2ass_item.substring(3, 5)+css2ass_item.substring(1, 3);
							}
							
							// 处理#开头的
							if(colorIndex != -1 && findColorArray[colorIndex] != undefined && color_item.substring(0, 1) =="#") {
								color = findColorArray[colorIndex].substring(1, 7);
								colorASS = "H" + findColorArray[colorIndex].substring(5, 7)+findColorArray[colorIndex].substring(3, 5)+findColorArray[colorIndex].substring(1, 3);
							}
							
						}
						
						// 处理表情
						var frist = item["__text"].substring(0,1);
						if(frist == "/") {
							return true;
						}

						// AA弹幕
						var textAA = item["__text"].split("\n");

						if (item.hasOwnProperty("_mail") && (item["_mail"].indexOf("shita") != -1 || item["_mail"].indexOf("ue") != -1 || item["_mail"].indexOf("naka") != -1 ) ) {
							textAA.map((item, index) => {
								var juzi = `Dialogue: 4,${startTime},${endTime},AA,,0,0,0,,{\\an4\\fsp-1\\pos(${videoWidth/2-250}, ${(AASize-6)*index+AAHighAdjust})\\1c&${colorASS}&}${item}\n`;
							
								juziAA += juzi;
							});
							
						} else {
							textAA.map((item, index) => {
								var juzi = `Dialogue: 4,${startTime},${endTime},AA,,0,0,0,,{\\an4\\fsp-1\\move(${videoWidth}, ${(AASize-6)*index+AAHighAdjust}, ${-px64*10}, ${(AASize-6)*index+AAHighAdjust})\\1c&${colorASS}&}${item}\n`;
							
								juziAA += juzi;
							});
						}

						
						
						var AAstartTime = timeFormat_AA(parseInt(startSecondsArray[0]));
						
						if ( allAAStartTimeArray.indexOf(AAstartTime) == -1 ) {
							allAAStartTimeArray.push(AAstartTime);
						}
	
						return true;
					}
					
					// 屏蔽关键词
					for (let i = 0; i < filterKeywordsArrays.length; i++) {
						if(filterKeywordsArrays[i] != "" && item["__text"].indexOf(filterKeywordsArrays[i]) != -1) {
							return true;
						}
					}
					
					// 底层弹幕
					if (item.hasOwnProperty("_mail") && item["_mail"].indexOf("shita") != -1) {
						// 处理颜色 默认白色
						var color = "ffffff";
						var colorASS = "HFFFFFF";
						if(item.hasOwnProperty("_mail")) {
							// orange4 solid ???
							var findColorArray = item["_mail"].split(" ");
							
							// 去除数字颜色的名字
							var colorName = "";
							
							// 找索引
							var colorIndex = findColorArray.findIndex((item, index) => {
								// 找不是开头#的 去掉数字
								if(findColorArray[index].substring(0, 1) !="#") {
									colorName = findColorArray[index].replace(/\d+/g,'')
								}
								
								var css2ass_find_item = css2ass[colorName];
								// 找black的
								if(css2ass_find_item != undefined && css2ass_find_item.substring(0, 1) =="#") {
									return true;
								}
								
								// 找#开头的
								if(findColorArray[index] != undefined && findColorArray[index].substring(0, 1) =="#") {
									return true;
								}
							});
						
							var color_item = findColorArray[colorIndex];
							// 处理black的
							var css2ass_item = css2ass[colorName];
							if(colorIndex != -1 && css2ass_item != undefined && css2ass_item.substring(0, 1) =="#") {
								color = css2ass[colorName].substring(1, 7);
								colorASS = "H" + css2ass_item.substring(5, 7)+css2ass_item.substring(3, 5)+css2ass_item.substring(1, 3);
							}
							
							// 处理#开头的
							if(colorIndex != -1 && findColorArray[colorIndex] != undefined && color_item.substring(0, 1) =="#") {
								color = findColorArray[colorIndex].substring(1, 7);
								colorASS = "H" + findColorArray[colorIndex].substring(5, 7)+findColorArray[colorIndex].substring(3, 5)+findColorArray[colorIndex].substring(1, 3);
							}
						}

						// 处理默认结束时间4秒
						endSeconds = (item["_vpos"]/100+4).toFixed(2);
						endSecondsArray = endSeconds.toString().split(".");
						endTime = timeFormat(parseInt(endSecondsArray[0]))+"."+endSecondsArray[1];

						var juzi = `Dialogue: 2,${startTime},${endTime},Shita,,0,0,0,,{\\an2\\1c&${colorASS}&}${item["__text"]}\n`;
						juziShita += juzi;
						
						return true;
					}
					
					// 处理表情
					var frist = item["__text"].substring(0,1);
					if(frist == "/") {
						return true;
					}
					
					// 处理颜色
					if (item.hasOwnProperty("_mail")) {
						// 处理颜色 默认白色
						var color = "ffffff";
						var colorASS = "HFFFFFF";
						if(item.hasOwnProperty("_mail")) {
							// orange4 solid ???
							var findColorArray = item["_mail"].split(" ");
							
							// 去除数字颜色的名字
							var colorName = "";
							
							// 找索引
							var colorIndex = findColorArray.findIndex((item, index) => {
								// 找不是开头#的 去掉数字
								if(findColorArray[index].substring(0, 1) !="#") {
									colorName = findColorArray[index].replace(/\d+/g,'')
								}
								
								var css2ass_find_item = css2ass[colorName];
								// 找black的
								if(css2ass_find_item != undefined && css2ass_find_item.substring(0, 1) =="#") {
									return true;
								}
								
								// 找#开头的
								if(findColorArray[index] != undefined && findColorArray[index].substring(0, 1) =="#") {
									return true;
								}
							});
						
							var color_item = findColorArray[colorIndex];
							// 处理black的
							var css2ass_item = css2ass[colorName];
							if(colorIndex != -1 && css2ass_item != undefined && css2ass_item.substring(0, 1) =="#") {
								color = css2ass[colorName].substring(1, 7);
								colorASS = "H" + css2ass_item.substring(5, 7)+css2ass_item.substring(3, 5)+css2ass_item.substring(1, 3);
							}
							
							// 处理#开头的
							if(colorIndex != -1 && findColorArray[colorIndex] != undefined && color_item.substring(0, 1) =="#") {
								color = findColorArray[colorIndex].substring(1, 7);
								colorASS = "H" + findColorArray[colorIndex].substring(5, 7)+findColorArray[colorIndex].substring(3, 5)+findColorArray[colorIndex].substring(1, 3);
							}
						}
					}
					
					var newObject = {
						"start": item["_vpos"]/100,
						"style": "scroll",
						"color": color,
						"commenter": item["_user_id"],
						"content": item["__text"],
						"is_guest": false
					};
					// JSON
					newArray.push(newObject);
					// XML
					allChat.push(item);

					
					// 普通弹幕
					// 处理默认开始时间
					var sta = item["_vpos"]/100+startTimeAdjust
					startSeconds = (sta).toFixed(2);
					startSecondsArray = startSeconds.toString().split(".");
					startTime = timeFormat(parseInt(startSecondsArray[0]))+"."+startSecondsArray[1];
					
					// 处理默认结束时间8秒
					var eta = item["_vpos"]/100+(16+startTimeAdjust)
					endSeconds = (eta).toFixed(2);
					endSecondsArray = endSeconds.toString().split(".");
					endTime = timeFormat(parseInt(endSecondsArray[0]))+"."+endSecondsArray[1];
					
					
					// 计算字符串字数长度
					var textLength = Math.ceil(strlen(item["__text"])/2);	// 多少个字
					var textWidth = textLength*(danmakuSize+danmakuFontSpace);	// 多少长度
					var danmakuLineHeight_half = Math.ceil(danmakuLineHeight/2);	// 一半高度
					
					
					// 计算经过秒数
					var realSpeed = 6000+1000*danmakuSpeedAdjust;
					
					// 分割的字数
					var shortLength = 4;
					var longLength = 12;
					
					if ($useSpeedA.checked) {
						// 速度算法
						if ( textLength <= shortLength) {
							realSpeed = (6000-shortLength*(danmakuSize+danmakuFontSpace))+Math.ceil(shortLength*(danmakuSize+danmakuFontSpace)*(textLength/shortLength))+1000*danmakuSpeedAdjust;
						} 
						else if ( textLength >= longLength) {
							realSpeed = 6000+Math.ceil(2*(danmakuSize+danmakuFontSpace)*(textLength-longLength))+1000*danmakuSpeedAdjust;
						}
						else {
							realSpeed = 6000+1000*danmakuSpeedAdjust;
						}
					} 
					
					// 计算平均速度
					var averageSpeed = parseFloat( ((videoWidth+textWidth) / (realSpeed/1000)).toFixed(2) ) ;
					
					// 完成时间
					var finishTime =  parseFloat( (videoWidth / averageSpeed).toFixed(2) );

					// 该行经过该行字长度所需时间 也就是间隔最小时间
					var spaceTime = parseFloat( (textWidth / averageSpeed).toFixed(2) )  ;
					
					var passageway_index = 0;
					// 返回一条能加入的弹幕通道有i都是旧的
					passageway_index = danmakuPassageway.findIndex((st, i)=>{
						if( st == 0 ) {
							danmakuPassageway[i] = sta;
							danmakuPassageway_textWidth[i] = textWidth;
							danmakuPassageway_averageSpeed[i] = averageSpeed;
							danmakuPassageway_spaceTime[i] = spaceTime;
							danmakuPassageway_finishTime[i] = finishTime;
							return true;
						}
						
						// 两弹幕距离距离
						var range = (sta-st)*danmakuPassageway_averageSpeed[i] + danmakuDensity;
						// 相遇的时间
						
						// console.log(range,danmakuPassageway_textWidth[i],item["__text"]);
						
						if (range >= danmakuPassageway_textWidth[i]) {
							// 旧长于新
							if (danmakuPassageway_textWidth[i] >= textWidth) {
								danmakuPassageway[i] = sta;
								danmakuPassageway_textWidth[i] = textWidth;
								danmakuPassageway_averageSpeed[i] = averageSpeed;
								danmakuPassageway_spaceTime[i] = spaceTime;
								danmakuPassageway_finishTime[i] = finishTime;
								return true;
							} 
							else {
								var catchTime = parseFloat( ( (range-danmakuPassageway_textWidth[i]) / (averageSpeed - danmakuPassageway_averageSpeed[i]) ).toFixed(2) );

								if (catchTime > 0 && (danmakuPassageway_finishTime[i] - (sta-st)) < catchTime ) {

									danmakuPassageway[i] = sta;
									danmakuPassageway_textWidth[i] = textWidth;
									danmakuPassageway_averageSpeed[i] = averageSpeed;
									danmakuPassageway_spaceTime[i] = spaceTime;
									danmakuPassageway_finishTime[i] = finishTime;
									return true;
								}
							}
						}
					})

					// 计算位置
					var sx = videoWidth;
					var sy = danmakuLineHeight_half + danmakuLineHeight*(passageway_index);
					
					var ex = (0-textWidth);
					var ey = danmakuLineHeight_half + danmakuLineHeight*(passageway_index);
					
					// 普通弹幕行超出屏幕行数
					if (passageway_index == -1) {
						return true;
					}
					
					// 转assCode代码
					if (assCode != "") {
						assCode = assCode.replace(/\\/g,'\\');
					}
					// 是否使用颜色
					if ($useAssColors.checked != true || item.hasOwnProperty("_mail") ==false) {
						colorASS = "HFFFFFF";
					}
					
					// 是否区分会员非会员颜色
					var alphaASS = "";
					if ($difficultVIP.checked && item["_premium"] =="25") {
						alphaASS = "\\alpha&H80&";
					}
					
					if ($filterOutsider.checked && item["_premium"] =="25") {
						return true;
					}

					var juzi = `Dialogue: 1,${startTime},${endTime},Danmaku,,0,0,0,,{\\an4\\move(${sx},${sy},${ex},${ey},0,${realSpeed})}{\\1c&${colorASS}&}{${alphaASS}}{${assCode}}${item["__text"]}\n`;
					juziDamaku += juzi;
					
				})	// 句子循环
				
				// 新数组排序
				newArray.sort(sortStart);
				
				// 输出弹幕
				juziOffice = "Comment: 0,0:00:00.00,0:00:00.00,Office,,0,0,0,,运营弹幕\n" + juziOffice + "Comment: 0,0:00:00.00,0:00:00.00,Office,,0,0,0,,\n";
				juziShita = "Comment: 0,0:00:00.00,0:00:00.00,Shita,,0,0,0,,底部弹幕\n" + juziShita + "Comment: 0,0:00:00.00,0:00:00.00,Shita,,0,0,0,,\n";
				juziAA = "Comment: 0,0:00:00.00,0:00:00.00,AA,,0,0,0,,AA弹幕\n" + juziAA + "Comment: 0,0:00:00.00,0:00:00.00,Danmaku,,0,0,0,,\n";
				
				juzis += juziOffice + juziShita + juziAA;
				
				allDanmaku += juzis + juziDamaku;
				
				if(!jsonObjectAll_XML.hasOwnProperty("NiconamaComment")) {
					jsonObjectAll_XML["packet"]["chat"] = allChat;
				} else {
					jsonObjectAll_XML["NiconamaComment"]["LiveCommentDataArray"]["chat"] = allChat;
				}
				
				// 显示AA弹幕列表
				var $AA = document.getElementById("AA");
				var allAAStartTimeText = "";
				
				allAAStartTimeArray.map( (item,index) => {
					allAAStartTimeText += `【${item}】`;
				});
				
				
				if (allAAStartTimeArray.length > 0) {
					$AA.innerHTML = allAAStartTimeText;
				}
				
			}
			
			function newJsonSave() {
				main();
				// Blob流
				var newJSON = JSON.stringify(newArray);
				var blob = new Blob([newJSON], {type: "text/plain;charset=utf-8"});
				saveAs(blob, "普通弹幕.json");
			}
			
			function newAssSave() {
				main();
				// Blob流
				var blob = new Blob([juzis], {type: "text/plain;charset=utf-8"});
				saveAs(blob, "特殊弹幕.ass");
			}
			
			function newXmlSave() {
				main();
				// Blob流
				var x2js = new X2JS({
					stripWhitespaces: false
				});
				
				// 转文本转成XML
				var newXML = x2js.json2xml_str( jsonObjectAll_XML );
				
				newXML = formateXml(newXML);
				
				var blob = new Blob([newXML], {type: "text/plain;charset=utf-8"});
				saveAs(blob, "去除特殊弹幕.xml");
				
			}
			
			function json2xmlSave() {
				let t = document.getElementById("nicoTitle").innerHTML + ".xml";
				var blob = new Blob([object2xmlText], {type: "text/plain;charset=utf-8"});
				saveAs(blob, t);
			}
			
			function newAllSave() {
				let t = document.getElementById("nicoTitle").innerHTML + ".ass";
				main();
				// Blob流
				var blob = new Blob([allDanmaku], {type: "text/plain;charset=utf-8"});
				saveAs(blob, t);
				
			}
			
			
			// 处理时间轴
			let timeFormat = (time) => {
				let timeStr = '';
				let stringFormat = (i) => {
					return i < 10 ? `0${i}` : `${i}`;
				}
				let minuteTime = 0;
				let secondTime = 0;
				let hourTime = 0;
			
				let _t = parseInt(time % 3600);
				hourTime = parseInt(time / 3600);
				minuteTime = parseInt(_t / 60);
				secondTime = parseInt(_t % 60);
				timeStr = `${stringFormat(hourTime)}:${stringFormat(minuteTime)}:${stringFormat(secondTime)}`
			
				return timeStr;
			}
			
			// AA显示专用处理时间轴
			let timeFormat_AA = (time) => {
				let timeStr = '';
				let stringFormat = (i) => {
					return i < 10 ? `0${i}` : `${i}`;
				}
				let minuteTime = 0;
				let secondTime = 0;
				let hourTime = 0;
			
				let _t = parseInt(time % 3600);
				hourTime = parseInt(time / 3600);
				minuteTime = parseInt(_t / 60);
				secondTime = parseInt(_t % 60);
				timeStr = `${stringFormat(minuteTime+hourTime*60)}:${stringFormat(secondTime)}`
			
				return timeStr;
			}
			
			// 处理字符串长度
			function strlen(str){
				var len = 0;
				for (var i=0; i<str.length; i++) { 
				 var c = str.charCodeAt(i); 
				//单字节加1
				 if ((c >= 0x0001 && c <= 0x007e) || (0xff60<=c && c<=0xff9f)) { 
					 len+=2; 
				 } 
				 else { 
					len+=2; 
				 } 
				} 
				return len;
			}
			
			// 排序
			function sortStart(a, b) {
				return a.start - b.start
			}
			
			// 排序
			function sort_vpos(a, b) {
				return a._vpos - b._vpos
			}
			
			//格式化xml代码
			function formateXml(xmlStr){
					text = xmlStr;
					//使用replace去空格
					text = '\n' + text.replace(/(<\w+)(\s.*?>)/g,function($0, name, props){
							return name + ' ' + props.replace(/\s+(\w+=)/g," $1");
					}).replace(/>\s*?</g,">\n<");
					//处理注释
					text = text.replace(/\n/g,'\r').replace(/<!--(.+?)-->/g,function($0, text){
							var ret = '<!--' + escape(text) + '-->';
							return ret;
					}).replace(/\r/g,'\n');
					//调整格式  以压栈方式递归调整缩进
					var rgx = /\n(<(([^\?]).+?)(?:\s|\s*?>|\s*?(\/)>)(?:.*?(?:(?:(\/)>)|(?:<(\/)\2>)))?)/mg;
					var nodeStack = [];
					var output = text.replace(rgx,function($0,all,name,isBegin,isCloseFull1,isCloseFull2 ,isFull1,isFull2){
							var isClosed = (isCloseFull1 == '/') || (isCloseFull2 == '/' ) || (isFull1 == '/') || (isFull2 == '/');
							var prefix = '';
							if(isBegin == '!'){//!开头
									prefix = setPrefix(nodeStack.length);
							}else {
									if(isBegin != '/'){///开头
											prefix = setPrefix(nodeStack.length);
											if(!isClosed){//非关闭标签
													nodeStack.push(name);
											}
									}else{
											nodeStack.pop();//弹栈
											prefix = setPrefix(nodeStack.length);
									}
							}
							var ret =  '\n' + prefix + all;
							return ret;
					});
					var prefixSpace = -1;
					var outputText = output.substring(1);
					//还原注释内容
					outputText = outputText.replace(/\n/g,'\r').replace(/(\s*)<!--(.+?)-->/g,function($0, prefix,  text){
							if(prefix.charAt(0) == '\r')
									prefix = prefix.substring(1);
							text = unescape(text).replace(/\r/g,'\n');
							var ret = '\n' + prefix + '<!--' + text.replace(/^\s*/mg, prefix ) + '-->';
							return ret;
					});
					outputText= outputText.replace(/\s+$/g,'').replace(/\r/g,'\r\n');
					return outputText;
			}
			 
			//计算头函数 用来缩进
			function setPrefix(prefixIndex) {
					var result = '';
					var span = '    ';//缩进长度
					var output = [];
					for(var i = 0 ; i < prefixIndex; ++i){
							output.push(span);
					}
					result = output.join('');
					return result;
			}
			
			// 字符串转HTML
			function parseToDOM(str){
				var div = document.createElement("div");
				if(typeof str == "string") {
					div.innerHTML = str;
				}
				// var a = div.firstChild;
				// var u = a.firstChild;
				// console.log(u.textContent);
				return div.childNodes;
			}
			
			// XML特殊符号转义
			function jsonToXml_RegExp(text) {
				let text_RegExp = "";
				
				// 替换转义字符
				var reg1 = new RegExp('<',"g"); // <
				var reg2 = new RegExp('>',"g"); // >
				var reg3 = new RegExp('&',"g"); // &
				// var reg4 = new RegExp("'","g"); // '
				// var reg5 = new RegExp('"',"g"); // "
				
				// text_RegExp = text.replace(reg1, "&lt;").replace(reg2, "&gt;").replace(reg3, "&amp;").replace(reg4, "&apos;").replace(reg5, '&quot;');
				text_RegExp = text.replace(reg3, "&amp;").replace(reg1, "&lt;").replace(reg2, "&gt;");
				return text_RegExp;
			}
			
			// 复制相关命令到剪贴板
			function copyDanmakuComment() {
				var clipboard = new Clipboard("#copyDanmakuComment");
				
				clipboard.on('success', function(e) {
					console.log(e);
				})
				
				clipboard.on('error', function(e) {
					console.log(e);
				})
			}
			
			// 复制相关命令到剪贴板
			function copyDanmakuCommentOnRoom() {
				var clipboard = new Clipboard("#copyDanmakuCommentOnRoom");
				
				clipboard.on('success', function(e) {
					console.log(e);
				})
				
				clipboard.on('error', function(e) {
					console.log(e);
				})
			}
			
			// 用户设置
			function saveUseSetting() {
				let useSetting = {
					limitLineAmount: document.getElementById("limitLineAmount").value,
					assCode: document.getElementById("assCode").value,
					danmakuSize: document.getElementById("danmakuSize").value,
					danmakuDensity: document.getElementById("danmakuDensity").value,
					startTimeAdjust: document.getElementById("startTimeAdjust").value,
					danmakuSpeedAdjust: document.getElementById("danmakuSpeedAdjust").value,
					useAssColors: document.getElementById("useAssColors").checked,
					difficultVIP: document.getElementById("difficultVIP").checked,
					filterOutsider: document.getElementById("filterOutsider").checked,
					useSpeedA: document.getElementById("useSpeedA").checked,
					manualAddOfficeId: document.getElementById("manualAddOfficeId").value,
					filterKeywords: document.getElementById("filterKeywords").value
				};
				useSetting = JSON.stringify(useSetting);
				window.localStorage.setItem('useSetting',useSetting);
			}
			
			function getUseSetting() {
				let useSetting = window.localStorage.getItem('useSetting');
				useSetting = JSON.parse(useSetting);

				document.getElementById("limitLineAmount").value = useSetting.limitLineAmount;
				document.getElementById("assCode").value = useSetting.assCode;
				document.getElementById("danmakuSize").value = useSetting.danmakuSize;
				document.getElementById("danmakuDensity").value = useSetting.danmakuDensity;
				document.getElementById("startTimeAdjust").value = useSetting.startTimeAdjust;
				document.getElementById("danmakuSpeedAdjust").value = useSetting.danmakuSpeedAdjust;
				document.getElementById("useAssColors").checked = useSetting.useAssColors;
				document.getElementById("difficultVIP").checked = useSetting.difficultVIP;
				document.getElementById("filterOutsider").checked = useSetting.filterOutsider;
				document.getElementById("useSpeedA").checked = useSetting.useSpeedA;
				document.getElementById("manualAddOfficeId").value = useSetting.manualAddOfficeId;
				document.getElementById("filterKeywords").value = useSetting.filterKeywords;
			}

			function defaultUseSetting() {
				let useSetting = {
					"limitLineAmount": "11",
					"assCode": "\\fnMS PGothic\\b1\\bord2\\blur0",
					"danmakuSize": "46",
					"danmakuDensity": "10",
					"startTimeAdjust": "0",
					"danmakuSpeedAdjust": "1",
					"useAssColors": true,
					"difficultVIP": false,
					"filterOutsider": false,
					"useSpeedA": false,
					"manualAddOfficeId": "",
					"filterKeywords": ""
				}
			
				document.getElementById("limitLineAmount").value = useSetting.limitLineAmount;
				document.getElementById("assCode").value = useSetting.assCode;
				document.getElementById("danmakuSize").value = useSetting.danmakuSize;
				document.getElementById("danmakuDensity").value = useSetting.danmakuDensity;
				document.getElementById("startTimeAdjust").value = useSetting.startTimeAdjust;
				document.getElementById("danmakuSpeedAdjust").value = useSetting.danmakuSpeedAdjust;
				document.getElementById("useAssColors").checked = useSetting.useAssColors;
				document.getElementById("difficultVIP").checked = useSetting.difficultVIP;
				document.getElementById("filterOutsider").checked = useSetting.filterOutsider;
				document.getElementById("useSpeedA").checked = useSetting.useSpeedA;
				document.getElementById("manualAddOfficeId").value = useSetting.manualAddOfficeId;
				document.getElementById("filterKeywords").value = useSetting.filterKeywords;
				
				window.localStorage.removeItem('useSetting');
			}
			
		</script>
		
	</body>
</html>
